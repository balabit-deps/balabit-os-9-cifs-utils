commit f4fd27cf60d6431d83ea18b4962aef845f9312bd
From: Henrique Carvalho <henrique.carvalho@suse.com>
Date: Fri, 30 May 2025 12:28:14 -0300
Subject: cifs.upcall: correctly treat UPTARGET_UNSPECIFIED as UPTARGET_APP
 Kernels lacking commit db363b0a1d9e ("CIFS: New mount option for
 cifs.upcall namespace resolution") omit the field upcall_target from the
 key description sent to cifs.upcall, leaving args->upcall_target as
 UPTARGET_UNSPECIFIED. That makes get_cachename_from_process_env() search
 root's environment instead of the applications's environment (default
 behavior), breaking some mounts.
 
 Explicitly set arg->upcall_target to UPTARGET_APP.
 
 Fixes: 89b679228cc1 ("CIFS.upcall to accommodate new namespace mount opt")
 Signed-off-by: Henrique Carvalho <henrique.carvalho@suse.com>
 Signed-off-by: Steve French <stfrench@microsoft.com>
Bug-Ubuntu: https://bugs.launchpad.net/bugs/2112614
Bug: https://bugs.launchpad.net/bugs/2099914
Origin: upstream, https://git.samba.org/?p=cifs-utils.git;a=commit;h=f4fd27cf60d6431d83ea18b4962aef845f9312bd
Last-Update: 2025-06-11

Index: cifs-utils-6.14/cifs.upcall.c
===================================================================
--- cifs-utils-6.14.orig/cifs.upcall.c	2025-06-11 17:09:34.747471906 +1200
+++ cifs-utils-6.14/cifs.upcall.c	2025-06-11 17:09:34.743376239 +1200
@@ -1365,6 +1365,7 @@
 	 */
 	if (arg->upcall_target == UPTARGET_APP || arg->upcall_target == UPTARGET_UNSPECIFIED) {
 		syslog(LOG_INFO, "upcall_target=app, switching namespaces to application thread");
+		arg->upcall_target = UPTARGET_APP;
 		rc = switch_to_process_ns(arg->pid);
 		if (rc == -1) {
 			syslog(LOG_ERR, "unable to switch to process namespace: %s", strerror(errno));
